<div class="container">
  <h2>My Subjects</h2>

  <div class="tutors-grid">
    <% @studies.each do |study| %>
      <div class="tutor-card d-flex flex-column" style="height:100%">
        <div class="tutor-info flex-grow-1">
          <h5>
            <%= study.subject.name %> (<%= study.subject.grade_level %>)
          </h5>

          <p>
            <strong>Learning Objective:</strong> <%= study.learning_objective %>
          </p>

          <!-- Tutoring Sessions for this Study -->
          <% most_recent_session = study.tutoring_sessions.order(start_time: :desc).first %>
          <% if most_recent_session %>
            <div class="mt-3">
              <strong>Upcoming Session:</strong>
              <div>
                <i class="bi bi-calendar-event"></i>
                <%= most_recent_session.start_time.strftime("%A, %b %d at %I:%M %p") %>
                <% if most_recent_session.expertise && most_recent_session.expertise.user %>
                  <br/>
                  <small>with <%= most_recent_session.expertise.user.first_name %> <%= most_recent_session.expertise.user.last_name %></small>
                <% end %>
              </div>
            </div>
          <% else %>
            <div class="mt-3 d-flex align-items-center gap-2">
              <strong class="mb-0">No upcoming sessions.</strong>
              <%= link_to "Book Session", tutors_path(subject_id: study.subject.id), class: "btn btn-purple btn-sm rounded-pill" %>
            </div>
          <% end %>
        </div>
        <div class="button-group mt-3 d-flex flex-column gap-2 align-items-center w-100">
          <%= link_to 'Upload Study Materials', new_study_material_path(study), class: "btn btn-purple btn-sm rounded-pill" %>
          <%= link_to 'View Generated Materials', study_materials_path(study), class: "btn btn-purple btn-sm rounded-pill" %>
        </div>
      </div>
    <% end %>
  </div>

  <div class="d-flex gap-2 mt-4">
    <%= link_to "Add a New Subject", new_study_path, class: "btn btn-purple btn-sm rounded-pill" %>
  </div>