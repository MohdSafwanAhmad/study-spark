<%# Tutors Index Page %>
<div class="container">
  <h1>Our Tutors</h1>

  <div class="filter-tabs mb-4">
    <%= form_with url: tutors_path, method: :get, local: true, class: "filter-form" do %>
      <div class="row align-items-end">
        <div class="col-md-8">
          <%= label_tag :subject_id, "Subject", class: "form-label" %>
          <%= select_tag :subject_id, options_for_select([
            ["All Subjects", ""],
            ["My Subjects", "my_subjects"]
          ] + Subject.all.map { |s| [s.name, s.id] }, params[:subject_id]), class: "form-select" %>
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <%= submit_tag "Filter", class: "btn btn-purple w-100 ms-2" %>
        </div>
      </div>
    <% end %>
  </div>

  <div class="tutors-grid">
    <%# learner_subject_ids = current_user.study_subjects.pluck(:id) %>
    <% @tutors.each do |tutor| %>
      <%# matching_expertises = tutor.expertises.includes(:subject).where(subject_id: learner_subject_ids) %>
      <div class="tutor-card">
        <div class="tutor-info">
          <h2><%= tutor.first_name %> <%= tutor.last_name %></h2>
          <p class="email"><%= tutor.email %></p>
          
          <%# Display expertise subjects %>
          <p class="expertise">
            <strong>Expertise:</strong>
            <ul>
              <% 
                # Determine which expertises to show
                if params[:subject_id] == "my_subjects" && user_signed_in?
                  learner_subject_ids = current_user.study_subjects.pluck(:id)
                  expertises = tutor.expertises.includes(:subject).where(subject_id: learner_subject_ids)
                elsif params[:subject_id].present? && params[:subject_id] != ""
                  expertises = tutor.expertises.includes(:subject).where(subject_id: params[:subject_id])
                else
                  expertises = tutor.expertises.includes(:subject)
                end
              %>
              <% expertises.each do |expertise| %>
                <li>
                  <%= expertise.subject.name %>
                  <% if expertise.tutor_rate.present? %>
                    - $<%= expertise.tutor_rate %>
                  <% end %>
                </li>
              <% end %>
            </ul>
          </p>

          <% if tutor.bio.present? %>
            <p class="bio"><%= tutor.bio %></p>
          <% end %>

          <%= link_to "View Profile", tutor_path(tutor), class: "button" %>
          <%= link_to "Book Session", new_tutoring_session_path(tutor_id: tutor.id), class: "button" %>
        </div>
      </div>
    <% end %>
  </div>

  <% if @tutors.empty? %>
    <p class="no-tutors">No tutors available at the moment.</p>
  <% end %>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const sortBtn = document.getElementById("sort-price-btn");
    const sortField = document.querySelector("input[name='sort']");
    if (sortBtn && sortField) {
      sortBtn.addEventListener("click", function() {
        if (sortField.value === "price_desc") {
          sortField.value = "price_asc";
        } else {
          sortField.value = "price_desc";
        }
        this.form.submit();
      });
    }
  });
</script>